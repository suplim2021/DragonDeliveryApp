<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Delivery Tracking</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Mobile First Styles - You'll expand this a lot */
        body { font-family: 'Noto Sans Thai', Arial, sans-serif; margin: 0; padding: 10px; background-color: #f0f0f0; }
        .container { background-color: white; padding: 15px; border-radius: 8px; margin-bottom:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #333; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 5px; width:100%; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #545b62; }
        button:disabled { background-color: #ccc; }
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .hidden { display: none !important; }
        .user-info { text-align: right; margin-bottom:15px; font-size:0.9em; }
        .page { padding-bottom: 60px; /* For fixed bottom nav */ }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #333; display: flex; justify-content: space-around; padding: 5px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index:1000; }
        .bottom-nav button { width: auto; background:none; color:white; padding: 10px 5px; font-size:0.8em; border:none; }
        .bottom-nav button.active { color: #007bff; font-weight:bold; }

        /* More specific styles for sections */
        .item-checklist { list-style-type: none; padding-left: 0; }
        .item-checklist li { padding: 5px; border-bottom: 1px solid #eee; }
        .item-checklist li:last-child { border-bottom: none; }
        .qr-scanner-area { width: 100%; max-width:400px; border:1px solid grey; margin:auto; }
        #photoPreview, #packingPhotoPreview { max-width:100%; max-height:200px; margin-top:10px; border:1px solid #ddd; display:block; }
        .summary-card { background-color:#fff; border-radius:8px; padding:15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex: 1; min-width: 150px; text-align:center; }
        .summary-card-icon { font-size: 2em; margin-bottom: 5px; }
        .summary-card-value { margin:0 0 5px 0; font-size:1.5em; font-weight:bold; }
        .summary-card-title { margin:0; color:#555; }
        .summary-card-subvalue { margin:5px 0 0 0; color:green; font-size:0.9em; }
        table { width:100%; border-collapse: collapse; font-size:0.9em; }
        th, td { padding:8px; border:1px solid #ddd; text-align:left; }
        thead tr { background-color:#f0f0f0; font-weight:bold; }

    </style>
    <!-- QR Scanner Library (Example: html5-qrcode) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="appContainer">
        <!-- Login Page (Initially Visible) -->
        <div id="loginPage" class="container page">
            <h2>Login</h2>
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="your@email.com">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="รหัสผ่าน">
            <button id="loginButton">เข้าสู่ระบบ</button>
            <p id="loginError" class="hidden" style="color:red;"></p>
        </div>

        <!-- Main App Area (Hidden until login) -->
        <div id="mainApp" class="hidden">
            <div class="user-info">
                Logged in as: <span id="userDisplayEmail"></span> (<span id="userDisplayRole"></span>)
                <button id="logoutButton" type="button" style="width:auto; font-size:0.8em; padding:5px; margin-left:10px;">Logout</button>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="container page current-page">
                <h2>Dashboard</h2>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span id="currentDateDisplay" style="font-size:0.9em;"></span>
                    <button id="refreshDashboardButton" type="button" class="secondary" style="width:auto; font-size:0.8em; padding:8px;">รีเฟรช</button>
                </div>
                <div id="summaryCardsContainer" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;"></div>
                <div id="chartsContainer" style="margin-bottom: 20px;">
                    <h3>สถิติรายวัน</h3>
                    <div style="height:250px;"><canvas id="dailyStatsChart"></canvas></div>
                    <h3 style="margin-top:20px;">สถิติตามแพลตฟอร์ม</h3>
                    <div style="height:280px; max-width:400px; margin:auto;"><canvas id="platformStatsChart"></canvas></div>
                </div>
                <div id="ordersLogContainer">
                    <h3>ประวัติพัสดุล่าสุด</h3>
                    <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                        <label for="logFilterStatus" style="margin-bottom:0;">สถานะ:</label>
                        <select id="logFilterStatus" style="width:auto; padding:8px; margin-bottom:0;">
                            <option value="all">ทั้งหมด</option>
                            <option value="Pending Item Details">รอเพิ่มสินค้า</option>
                            <option value="Ready to Pack">รอแพ็ก</option>
                            <option value="Pending Supervisor Pack Check">รอตรวจแพ็ก</option>
                            <option value="Ready for Shipment">รอส่ง</option>
                            <option value="Shipped">ส่งแล้ว</option>
                        </select>
                        <button id="applyLogFilterButton" type="button" class="secondary" style="width:auto; font-size:0.8em; padding:8px;">ค้นหา</button>
                    </div>
                    <div id="ordersTableContainer" style="max-height: 400px; overflow-y: auto; border:1px solid #ccc;">
                        <table><thead><tr style="background-color:#f0f0f0;">
                            <th>Order Key</th><th>Platform</th><th>Package Code</th><th>สถานะ</th><th>Due Date</th>
                        </tr></thead><tbody id="ordersTableBody"></tbody></table>
                    </div>
                    <p id="noOrdersMessage" class="hidden" style="text-align:center; padding:20px;">ไม่พบข้อมูลพัสดุ</p>
                </div>
            </div>

            <!-- Admin: Create Order Page -->
            <div id="adminCreateOrderPage" class="container page hidden">
                <h2>สร้างออเดอร์ใหม่</h2>
                <!-- ปุ่มเลือกกล้อง (ถ้าต้องการ) จะอยู่ตรงนี้ -->
                <button id="startQRScanButton_AdminOrder" type="button">สแกน QR ใบปะหน้า (รหัสพัสดุ)</button>
                <div id="qrScannerContainer_AdminOrder" class="hidden" style="margin-top:10px;">
                    <div id="qrScanner_AdminOrder" class="qr-scanner-area"></div>
                    <button id="stopQRScanButton_AdminOrder" type="button" class="secondary hidden" style="margin-top:5px;">หยุดสแกน</button>
                </div>
                <p>Scanned Package Code: <span id="scannedQRData_AdminOrder">N/A</span></p>

                <label for="adminPlatform">Platform:</label>
                <input type="text" id="adminPlatform" placeholder="จะถูก Detect อัตโนมัติ" readonly>

                <label for="adminPlatformOrderId">Platform Order ID (ถ้ามี):</label>
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="text" id="adminPlatformOrderId" placeholder="กรอกเอง หรือ สแกน" style="flex-grow: 1; margin-bottom:0;">
                    <button id="scanPlatformOrderIdButton" type="button" class="secondary" style="width:auto; padding: 8px; margin-left:5px; font-size:0.8em;">สแกน ID</button>
                </div>
                <div id="qrScannerContainer_PlatformOrderId" class="hidden" style="margin-top:5px;">
                    <div id="qrScanner_PlatformOrderId" class="qr-scanner-area"></div>
                    <button id="stopScanPlatformOrderIdButton" type="button" class="secondary hidden" style="margin-top:5px;">หยุดสแกน Platform ID</button>
                </div>

                <label for="adminPackageCode">Package Code:</label>
                <input type="text" id="adminPackageCode" placeholder="จะมาจาก QR ที่สแกน" readonly>

                <label for="adminDueDate">Due Date:</label>
                <input type="date" id="adminDueDate">

                <label for="adminNotes">หมายเหตุ (ถ้ามี):</label>
                <textarea id="adminNotes"></textarea>

                <button id="saveInitialOrderButton" type="button">บันทึกออเดอร์เบื้องต้น</button>
            </div>

            <!-- Admin: Add Items to Order Page -->
            <div id="adminAddItemsPage" class="container page hidden">
                <h2>เพิ่มรายการสินค้า (Order ID: <span id="currentOrderIdForItems"></span>)</h2>
                <label for="productSearch">ค้นหาสินค้า:</label>
                <input type="text" id="productSearch" placeholder="พิมพ์ชื่อสินค้า...">
                <label for="quantity">จำนวน:</label>
                <input type="number" id="quantity" value="1" min="1">
                <label for="unit">หน่วย:</label>
                <input type="text" id="unit" placeholder="เช่น ตัว, ชิ้น">
                <button id="addItemToOrderButton" type="button">เพิ่มสินค้าในรายการ</button>
                <h3>รายการสินค้าที่เพิ่มแล้ว:</h3>
                <ul id="itemListCurrentOrder" class="item-checklist"></ul>
                <button id="confirmAllItemsButton" type="button">ยืนยันรายการสินค้าทั้งหมด</button>
            </div>
            
            <!-- Operator: Packing Page -->
            <div id="operatorPackingPage" class="container page hidden">
                <h2>แพ็กสินค้า (Order ID: <span id="currentOrderIdForPacking"></span>)</h2>
                <p><strong>Platform:</strong> <span id="packOrderPlatform"></span></p>
                <p><strong>Due Date:</strong> <span id="packOrderDueDate"></span></p>
                <h3>Checklist รายการสินค้า:</h3>
                <ul id="packOrderItemList" class="item-checklist"></ul>
                <label for="packingPhoto">ถ่ายรูปสินค้าที่เตรียม:</label>
                <input type="file" id="packingPhoto" accept="image/*" capture="environment">
                <img id="packingPhotoPreview" src="#" alt="Preview" class="hidden">
                <label for="operatorPackNotes">หมายเหตุ (ถ้ามี):</label>
                <textarea id="operatorPackNotes"></textarea>
                <button id="confirmPackingButton" type="button">ยืนยันการแพ็ก</button>
                <div id="supervisorPackCheckResult" class="hidden" style="margin-top:15px; padding:10px; border:1px solid #ccc;">
                    <h4>ผลการตรวจสอบโดย Supervisor:</h4>
                    <p>สถานะ: <span id="packCheckStatus"></span></p>
                    <p>ผู้ตรวจ: <span id="packCheckSupervisor"></span></p>
                    <p>หมายเหตุ: <span id="packCheckNotes"></span></p>
                </div>
            </div>
            
            <p id="appStatus" style="text-align:center; padding:10px;"></p>
        </div>

        <div id="bottomNavContainer" class="bottom-nav hidden"></div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, update, serverTimestamp, push, child, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGWAYD5mvDsyyY4IovRjYUYPpj7WLUrFE",
            authDomain: "dragondeliveryapp.firebaseapp.com",
            projectId: "dragondeliveryapp",
            storageBucket: "dragondeliveryapp.firebasestorage.app",
            messagingSenderId: "912014929398",
            appId: "1:912014929398:web:8488118a158c0d8d936bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        let currentUser = null;
        let currentUserRole = null;
        let html5QrCodeScannerAdminOrder = null;
        let html5QrCodeScannerPlatformOrderId = null;
        let dailyChartInstance = null;
        let platformChartInstance = null;

        const loginPage = document.getElementById('loginPage');
        const mainApp = document.getElementById('mainApp');
        const loginButton = document.getElementById('loginButton');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const userDisplayEmail = document.getElementById('userDisplayEmail');
        const userDisplayRole = document.getElementById('userDisplayRole');
        const logoutButton = document.getElementById('logoutButton');
        const appStatus = document.getElementById('appStatus');
        const bottomNavContainer = document.getElementById('bottomNavContainer');

        const adminCreateOrderPage = document.getElementById('adminCreateOrderPage');
        const startQRScanButton_AdminOrder = document.getElementById('startQRScanButton_AdminOrder');
        const qrScannerContainer_AdminOrder = document.getElementById('qrScannerContainer_AdminOrder');
        const qrScanner_AdminOrder_div = document.getElementById('qrScanner_AdminOrder');
        const stopQRScanButton_AdminOrder = document.getElementById('stopQRScanButton_AdminOrder');
        const scannedQRData_AdminOrder = document.getElementById('scannedQRData_AdminOrder');
        const adminPlatformInput = document.getElementById('adminPlatform');
        const adminPlatformOrderIdInput = document.getElementById('adminPlatformOrderId');
        const scanPlatformOrderIdButton = document.getElementById('scanPlatformOrderIdButton');
        const qrScannerContainer_PlatformOrderId = document.getElementById('qrScannerContainer_PlatformOrderId');
        const qrScanner_PlatformOrderId_div = document.getElementById('qrScanner_PlatformOrderId');
        const stopScanPlatformOrderIdButton = document.getElementById('stopScanPlatformOrderIdButton');
        const adminPackageCodeInput = document.getElementById('adminPackageCode');
        const adminDueDateInput = document.getElementById('adminDueDate');
        const adminNotesInput = document.getElementById('adminNotes');
        const saveInitialOrderButton = document.getElementById('saveInitialOrderButton');

        const adminAddItemsPage = document.getElementById('adminAddItemsPage');
        const currentOrderIdForItemsSpan = document.getElementById('currentOrderIdForItems');
        const productSearchInput = document.getElementById('productSearch');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');
        const addItemToOrderButton = document.getElementById('addItemToOrderButton');
        const itemListCurrentOrderUL = document.getElementById('itemListCurrentOrder');
        const confirmAllItemsButton = document.getElementById('confirmAllItemsButton');
        
        const operatorPackingPage = document.getElementById('operatorPackingPage');
        const currentOrderIdForPackingSpan = document.getElementById('currentOrderIdForPacking');
        const packOrderPlatformSpan = document.getElementById('packOrderPlatform');
        const packOrderDueDateSpan = document.getElementById('packOrderDueDate');
        const packOrderItemListUL = document.getElementById('packOrderItemList');
        const packingPhotoInput = document.getElementById('packingPhoto');
        const packingPhotoPreviewImg = document.getElementById('packingPhotoPreview');
        const operatorPackNotesTextarea = document.getElementById('operatorPackNotes');
        const confirmPackingButton = document.getElementById('confirmPackingButton');
        const supervisorPackCheckResultDiv = document.getElementById('supervisorPackCheckResult');
        const packCheckStatusSpan = document.getElementById('packCheckStatus');
        const packCheckSupervisorSpan = document.getElementById('packCheckSupervisor');
        const packCheckNotesSpan = document.getElementById('packCheckNotes');

        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const refreshDashboardButton = document.getElementById('refreshDashboardButton');
        const summaryCardsContainer = document.getElementById('summaryCardsContainer');
        const dailyStatsChartCanvas = document.getElementById('dailyStatsChart');
        const platformStatsChartCanvas = document.getElementById('platformStatsChart');
        const logFilterStatusSelect = document.getElementById('logFilterStatus');
        const applyLogFilterButton = document.getElementById('applyLogFilterButton');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        const allPages = document.querySelectorAll('.page');
        function showPage(pageId) {
            allPages.forEach(page => page.classList.add('hidden'));
            allPages.forEach(page => page.classList.remove('current-page'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('current-page');
            }
            updateBottomNavActiveState(pageId);

            if (pageId === 'adminCreateOrderPage') {
                setDefaultDueDate();
                adminPlatformInput.value = ''; adminPlatformInput.readOnly = true; // Platform จะถูก detect
                adminPlatformOrderIdInput.value = '';
                adminPackageCodeInput.value = ''; adminPackageCodeInput.readOnly = true; // Package code มาจาก QR
                adminNotesInput.value = '';
                scannedQRData_AdminOrder.textContent = 'N/A';
                qrScannerContainer_AdminOrder.classList.add('hidden'); // ซ่อน QR scanner ของ Package Code
                stopQRScanButton_AdminOrder.classList.add('hidden');
                qrScannerContainer_PlatformOrderId.classList.add('hidden'); // ซ่อน QR scanner ของ Platform Order ID
                stopScanPlatformOrderIdButton.classList.add('hidden');

            } else if (pageId === 'dashboardPage') {
                updateCurrentDate();
                loadDashboardData();
            }
        }

        function setDefaultDueDate() {
            const now = new Date();
            const currentHour = now.getHours();
            let defaultDueDate = new Date(now);
            if (currentHour >= 12) { defaultDueDate.setDate(now.getDate() + 1); }
            adminDueDateInput.value = defaultDueDate.toISOString().slice(0,10);
        }

        function updateBottomNavActiveState(currentPageId) { /* ... (เหมือนเดิม) ... */ }
        onAuthStateChanged(auth, async (user) => { /* ... (เหมือนเดิม) ... */ });
        loginButton.addEventListener('click', () => { /* ... (เหมือนเดิม) ... */ });
        logoutButton.addEventListener('click', () => { /* ... (เหมือนเดิม) ... */ });
        function setupRoleBasedUI() { /* ... (เหมือนเดิม) ... */ }
        window.navigateToOperatorScanToPack = function() { /* ... (เหมือนเดิม) ... */ }

        function detectPlatformFromPackageCode(packageCode) {
            if (!packageCode) return "Unknown";
            const code = packageCode.toUpperCase();
            if ((code.startsWith("TH") && code.length >= 12) || code.startsWith("SPX")) return "Shopee";
            if (code.includes("LEX") || code.startsWith("LX")) return "Lazada";
            if (code.startsWith("JT") || code.startsWith("JTS") || code.startsWith("KER")) return "Tiktok";
            return "Unknown";
        }

        function onScanSuccess_AdminOrder(decodedText, decodedResult) {
            const packageCode = decodedText.trim();
            scannedQRData_AdminOrder.textContent = packageCode;
            adminPackageCodeInput.value = packageCode;
            adminPackageCodeInput.readOnly = true;
            const detectedPlatform = detectPlatformFromPackageCode(packageCode);
            adminPlatformInput.value = detectedPlatform;
            adminPlatformInput.readOnly = true;
            if (!adminPlatformOrderIdInput.value.trim()) adminPlatformOrderIdInput.focus();
            if (html5QrCodeScannerAdminOrder) {
                html5QrCodeScannerAdminOrder.stop().then(() => {
                    qrScannerContainer_AdminOrder.classList.add('hidden');
                    stopQRScanButton_AdminOrder.classList.add('hidden');
                }).catch(err => {
                    console.warn("Error stopping main QR scanner:", err);
                    qrScannerContainer_AdminOrder.classList.add('hidden');
                    stopQRScanButton_AdminOrder.classList.add('hidden');
                });
            }
        }
        function onScanFailure_AdminOrder(error) { /* console.warn(`QR error = ${error}`); */ }

        startQRScanButton_AdminOrder.addEventListener('click', () => {
            qrScannerContainer_AdminOrder.classList.remove('hidden');
            stopQRScanButton_AdminOrder.classList.remove('hidden');
            startQRScanButton_AdminOrder.disabled = true;
            if (!html5QrCodeScannerAdminOrder) {
                html5QrCodeScannerAdminOrder = new Html5Qrcode("qrScanner_AdminOrder", false);
            }
            html5QrCodeScannerAdminOrder.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess_AdminOrder, onScanFailure_AdminOrder)
            .catch(err => {
                alert("ไม่สามารถเปิดกล้องสแกน QR ได้: " + err.message);
                qrScannerContainer_AdminOrder.classList.add('hidden');
                stopQRScanButton_AdminOrder.classList.add('hidden');
                startQRScanButton_AdminOrder.disabled = false;
            });
        });
        stopQRScanButton_AdminOrder.addEventListener('click', () => {
            if (html5QrCodeScannerAdminOrder) html5QrCodeScannerAdminOrder.stop().catch(e=>console.warn(e));
            qrScannerContainer_AdminOrder.classList.add('hidden');
            stopQRScanButton_AdminOrder.classList.add('hidden');
            startQRScanButton_AdminOrder.disabled = false;
        });

        scanPlatformOrderIdButton.addEventListener('click', () => {
            qrScannerContainer_PlatformOrderId.classList.remove('hidden');
            stopScanPlatformOrderIdButton.classList.remove('hidden');
            scanPlatformOrderIdButton.disabled = true;
            if (!html5QrCodeScannerPlatformOrderId) {
                html5QrCodeScannerPlatformOrderId = new Html5Qrcode("qrScanner_PlatformOrderId", false);
            }
            html5QrCodeScannerPlatformOrderId.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } },
                (decodedText, decodedResult) => {
                    adminPlatformOrderIdInput.value = decodedText.trim();
                    if (html5QrCodeScannerPlatformOrderId) html5QrCodeScannerPlatformOrderId.stop().catch(e => console.warn(e));
                    qrScannerContainer_PlatformOrderId.classList.add('hidden');
                    stopScanPlatformOrderIdButton.classList.add('hidden');
                    scanPlatformOrderIdButton.disabled = false;
                }, (errorMessage) => {})
            .catch(err => {
                alert("ไม่สามารถเปิดกล้องสแกน Platform Order ID ได้: " + err.message);
                qrScannerContainer_PlatformOrderId.classList.add('hidden');
                stopScanPlatformOrderIdButton.classList.add('hidden');
                scanPlatformOrderIdButton.disabled = false;
            });
        });
        stopScanPlatformOrderIdButton.addEventListener('click', () => {
            if (html5QrCodeScannerPlatformOrderId) html5QrCodeScannerPlatformOrderId.stop().catch(e=>console.warn(e));
            qrScannerContainer_PlatformOrderId.classList.add('hidden');
            stopScanPlatformOrderIdButton.classList.add('hidden');
            scanPlatformOrderIdButton.disabled = false;
        });

        saveInitialOrderButton.addEventListener('click', async () => {
            if (currentUserRole !== 'administrator') { appStatus.textContent = "ไม่มีสิทธิ์"; return; }
            const platform = adminPlatformInput.value.trim();
            const platformOrderId = adminPlatformOrderIdInput.value.trim();
            const packageCode = adminPackageCodeInput.value.trim();
            const dueDate = adminDueDateInput.value;
            const notes = adminNotesInput.value.trim();

            if (!packageCode || platform === "Unknown" || !platform) {
                appStatus.textContent = "กรุณาสแกนรหัสพัสดุและตรวจสอบ Platform"; return;
            }
            if (!platformOrderId) { // Platform Order ID อาจจะเป็น Optional หรือจำเป็น แล้วแต่คุณกำหนด
                appStatus.textContent = "กรุณากรอก Platform Order ID"; return;
            }

            const orderKey = `${platform}_${platformOrderId}_${packageCode}`.replace(/[^a-zA-Z0-9_-]/g, ''); // Sanitize key
            if (!orderKey) { appStatus.textContent = "ไม่สามารถสร้าง Order Key ได้"; return; }


            const orderData = {
                qrRawData: scannedQRData_AdminOrder.textContent, platform, platformOrderId, packageCode,
                status: "Pending Item Details", dueDate: dueDate || null, notes: notes || null,
                createdAt: serverTimestamp(), createdBy_adminUid: currentUser.uid, items: {}
            };
            try {
                await set(ref(database, 'orders/' + orderKey), orderData);
                appStatus.textContent = `สร้างออเดอร์ ${orderKey} สำเร็จ! เพิ่มรายการสินค้าต่อ`;
                adminPlatformInput.value = ''; adminPlatformInput.readOnly = true;
                adminPlatformOrderIdInput.value = '';
                adminPackageCodeInput.value = ''; adminPackageCodeInput.readOnly = true;
                setDefaultDueDate(); adminNotesInput.value = '';
                scannedQRData_AdminOrder.textContent = 'N/A';
                loadOrderForAddingItems(orderKey);
            } catch (error) {
                appStatus.textContent = "Error: " + error.message;
            }
        });

        let currentOrderKeyForItems = null;
        function loadOrderForAddingItems(orderKey) { /* ... (เหมือนเดิม) ... */ }
        function renderItemInList(itemId, itemData) { /* ... (เหมือนเดิม) ... */ }
        addItemToOrderButton.addEventListener('click', async () => { /* ... (เหมือนเดิม) ... */ });
        confirmAllItemsButton.addEventListener('click', async () => { /* ... (เหมือนเดิม) ... */ });
        let currentOrderKeyForPacking = null; let packingPhotoFile = null;
        async function loadOrderForPacking(orderKey) { /* ... (เหมือนเดิม) ... */ }
        packingPhotoInput.addEventListener('change', (event) => { /* ... (เหมือนเดิม) ... */ });
        confirmPackingButton.addEventListener('click', async () => { /* ... (เหมือนเดิม) ... */ });

        function updateCurrentDate() { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า) ... */ }
        async function loadDashboardData() { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า) ... */ }
        function updateSummaryCards(orders) { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า) ... */ }
        function createSummaryCard(title, value, subValue, icon) { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า) ... */ }
        function updateOrdersTable(orders, filterStatus = 'all') { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า) ... */ }
        function updateCharts(orders) { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า, แต่ต้องแน่ใจว่า Chart ถูก new อย่างถูกต้อง) ... */
            if (!orders || orders.length === 0 || typeof Chart === 'undefined') return; // เพิ่ม typeof Chart
             // --- Daily Stats Chart ---
            const dailyData = {};
            for (let i = 6; i >= 0; i--) { /* ... */ } orders.forEach(order => { /* ... */ });
            const dailyLabels = Object.keys(dailyData);
            const dailyCreatedCounts = dailyLabels.map(label => dailyData[label].created);
            const dailyShippedCounts = dailyLabels.map(label => dailyData[label].shipped);
            if (dailyChartInstance) dailyChartInstance.destroy();
            dailyChartInstance = new Chart(dailyStatsChartCanvas, { /* ... config ... */ });
            // --- Platform Stats Chart ---
            const platformCounts = {}; orders.forEach(order => { /* ... */ });
            if (platformChartInstance) platformChartInstance.destroy();
            platformChartInstance = new Chart(platformStatsChartCanvas, { /* ... config ... */ });
        }
        refreshDashboardButton.addEventListener('click', loadDashboardData);
        applyLogFilterButton.addEventListener('click', async () => { /* ... (เหมือนเดิมจากโค้ดก่อนหน้า) ... */ });
    </script>
</body>
</html>